# action.yml
name: "cppcheck and review"
author: myml
branding:
  icon: "check"
  color: "black"
description: "check pull request with cppcheck and post result to review comments"
inputs:
  app_id:
    description: "github app id"
    required: false
  installation_id:
    description: "github app installation id"
    required: false
  private_key:
    description: "github app private key"
    required: false
  github_token:
    description: "action github token"
    required: false
  repository:
    description: "owner and repository name"
    required: true
  pull_request_id:
    description: "pull request id"
    required: true
  allow_approve:
    description: "allow submit approve review"
    required: true
    default: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-go@v2
      with:
        go-version: ^1.17.1
    - name: run
      shell: bash
      run: |
        sudo apt-get install -y -q cppcheck
        cppcheck --enable=all --output-file=report.xml --xml .
    - name: install action bin
      shell: bash
      run: |
        go env -w GO111MODULE=on
        go install github.com/myml/action-cppcheck/cmd/action-cppcheck@latest
    - name: command
      shell: bash
      run: action-cppcheck -f=report.xml -repo=${{ inputs.repository }} -pr=${{ inputs.pull_request_id }} -approve=${{ inputs.allow_approve }} -app_id=${{ inputs.app_id }} -installation_id=${{ inputs.installation_id }}
      env:
        PRIVATE_KEY: ${{ inputs.private_key }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
